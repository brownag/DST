# Architecture Overview

## Design: No-Build Progressive Web App

No build tools (Webpack, Vite, Rollup). Code in repo = code in browser. Designed for 10+ year maintenance by soil scientists who use R/Python, not JS tooling.

- Alpine.js v3.13.3 via CDN — sole JS dependency
- Offline-first via Service Worker
- Deployable anywhere (GitHub Pages, static server, USB)

## Components

### index.html — Single-File App
All HTML, CSS, and JS in one file (~417 lines). Alpine.js reactive state drives the UI.

Key functions:
- `buildIndices()` — builds `clauseChildrenMap` for O(1) child lookups
- `isClauseSatisfied()` — recursive satisfaction with cache
- `evaluateSiblingLogic()` — partitions children by logic field (AND vs alternatives)
- `getVisibleGroups()` — determines visible taxonomy level
- `checkCriterion()` / `removeFromPath()` — user interaction handlers

### data/dst-data.json — Taxonomy Data (~3.5 MB)
Schema v1.0.0. Generated by Python pipeline — do not edit manually.
```json
{
  "version": "1.0.0",
  "generated": "2026-02-16",
  "source": "USDA Keys to Soil Taxonomy (2022)",
  "description": "Hierarchical soil taxonomy criteria and classification outcomes",
  "navigation": { "criteria": [...] },  // 5,706 decision nodes
  "outcomes": { ... },                  // 3,073 classification results (keyed by code)
  "glossary": { ... },                  // 124 terms with definitions
  "order_names": { ... },              // A→Gelisols, B→Histosols, ...
  "code_names": { ... },               // 3,153 entries: AA→Histels, AB→Turbels, ...
  "metadata": { "schema_version": "1.0.0", ... }
}
```

See [DATA_FORMAT.md](DATA_FORMAT.md) for field details.

### Python Pipeline (scripts/)
```
assets/*.json (USDA source)
  → build_tree.py         Build hierarchy from USDA JSON
  → apply_phase1.py       Separate navigation from outcomes
  → apply_phase2.py       Add indices
  → apply_phase3.py       Pre-linkify glossary terms → content_html
  → populate_code_names.py  Extract taxon names by code
  → validate_schema.py    47 assertions on output
  → data/dst-data.json
```

### sw.js — Service Worker
- Cache-first for static assets (`/`, `/index.html`, `/manifest.json`, `/style.css`, `/scripts/dst-core.js`)
- Network-first for data (`/data/dst-data.json`)
- Bump `CACHE_VERSION` when static files change (currently `v10-2026-03`)

## Data Flow

```
User clicks checkbox
  → checkCriterion(id)          Set checkedCriteria[id] = true
  → invalidateSatisfactionCaches()
  → isClauseSatisfied()         Recursive: leaf=checked?, parent=evaluateSiblingLogic(children)
  → evaluateSiblingLogic()      Partition children: AND=mandatory, others=alternatives
  → isGroupSatisfied()          Is entire order/suborder satisfied?
  → getVisibleGroups()          Show satisfied ancestors + next level options
  → Alpine.js reactivity        DOM updates automatically
```

## Hierarchy Levels

| Depth | Code | Example | Count |
|-------|------|---------|-------|
| 0 | A-L | Gelisols | 12 |
| 1 | AA-LL | Histels | ~68 |
| 2 | AAA-LLL | Folistels | ~339 |
| 3+ | AAAA+ | Typic Folistels | ~3,700 |
| -1 | — | Outcomes (display only) | 3,073 |

## Satisfaction Rules

Children's `logic` field determines how they contribute to parent satisfaction:
- **AND** (mandatory): ALL must be satisfied
- **OR** (alternatives): at least ONE must be satisfied
- Leaf nodes: satisfied when directly checked by the user

See [NAVIGATION_LOGIC.md](NAVIGATION_LOGIC.md) for the full algorithm, including mixed-logic run-grouping behavior.

## File Structure

```
index.html                 Single-file app
style.css                  CSS with light/dark custom properties
sw.js                      Service Worker
manifest.json              PWA manifest
test.html                  Test runner (browser)
scripts/
  dst-core.js              Standalone logic engine
  tests.js                 Test suite
  build_tree.py            Pipeline steps 1-6
  apply_phase1.py
  apply_phase2.py
  apply_phase3.py
  populate_code_names.py
  validate_schema.py
  validate-logic-consistency.js  3-class logic consistency validator
  sync-version.js          Syncs version between package.json and manifest.json
data/
  dst-data.json            Generated data
assets/
  *.json                   USDA source files
docs/
  ARCHITECTURE.md          This file
  DATA_FORMAT.md           JSON schema reference
  FUNCTION_REFERENCE.md    Function API docs
  MAINTENANCE.md           Data refresh & troubleshooting
  NAVIGATION_LOGIC.md      Algorithm specification
  PUBLICATION_GUIDE.md     Release workflow
```
