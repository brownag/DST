# Architecture Overview

## Design: No-Build Progressive Web App

No build tools (Webpack, Vite, Rollup). Code in repo = code in browser. Designed for 10+ year maintenance by soil scientists who use R/Python, not JS tooling.

- Alpine.js v3.13.3 via CDN — sole JS dependency
- Offline-first via Service Worker
- Deployable anywhere (GitHub Pages, static server, USB)

## Components

### index.html — Single-File App
All HTML, CSS, and JS in one file (~580 lines). Alpine.js reactive state drives the UI.

Key functions:
- `buildClauseIndex()` — builds `clauseChildrenMap` for O(1) child lookups
- `isClauseSatisfied()` — recursive satisfaction with cache
- `evaluateSiblingLogic()` — partitions children by logic field (AND vs alternatives)
- `updateVisibleGroups()` — determines visible taxonomy level
- `checkCriterion()` / `removeFromPath()` — user interaction (delegates to app_helpers.js)

### data/keys_optimized.json — Taxonomy Data (3.3 MB)
Schema v3.2.0. Generated by Python pipeline — do not edit manually.
```json
{
  "navigation": { "criteria": [...] },  // 4,127 decision nodes
  "outcomes": { ... },                  // 3,080 classification results (keyed by code)
  "glossary": { ... },                  // 136 terms with definitions
  "order_names": { ... },              // A→Gelisols, B→Histosols, ...
  "code_names": { ... },               // AA→Histels, AB→Turbels, ...
  "metadata": { "schema_version": "3.2.0", ... }
}
```

See [DATA_FORMAT.md](DATA_FORMAT.md) for field details.

### Python Pipeline (scripts/)
```
assets/*.json (USDA source)
  → build_tree.py         Build hierarchy from USDA JSON
  → apply_phase1.py       Separate navigation from outcomes
  → apply_phase2.py       Add indices
  → apply_phase3.py       Pre-linkify glossary terms → content_html
  → populate_code_names.py  Extract taxon names by code
  → validate_schema.py    47 assertions on output
  → data/keys_optimized.json
```

### sw.js — Service Worker
- Cache-first for static assets (`/`, `/index.html`, `/manifest.json`, `/scripts/app_helpers.js`)
- Network-first for data (`/data/keys_optimized.json`)
- Bump `CACHE_VERSION` when static files change

### scripts/app_helpers.js — State Helpers
Five extracted functions used by `checkCriterion()` and `removeFromPath()`: cache invalidation, reactivity triggers, navigation state updates.

## Data Flow

```
User clicks checkbox
  → checkCriterion(id)          Set checkedCriteria[id] = true
  → invalidateSatisfactionCaches()
  → isClauseSatisfied()         Recursive: leaf=checked?, parent=evaluateSiblingLogic(children)
  → evaluateSiblingLogic()      Partition children: AND=mandatory, others=alternatives
  → isGroupSatisfied()          Is entire order/suborder satisfied?
  → updateVisibleGroups()       Show satisfied ancestors + next level options
  → Alpine.js reactivity        DOM updates automatically
```

## Hierarchy Levels

| Depth | Code | Example | Count |
|-------|------|---------|-------|
| 0 | A-L | Gelisols | 12 |
| 1 | AA-LL | Histels | ~68 |
| 2 | AAA-LLL | Folistels | ~339 |
| 3+ | AAAA+ | Typic Folistels | ~3,700 |
| -1 | — | Outcomes (display only) | 3,080 |

## Satisfaction Rules

Children's `logic` field determines how they contribute to parent satisfaction:
- **AND** (mandatory): ALL must be satisfied
- **FIRST/OR/END** (alternatives): at least ONE must be satisfied
- Parent satisfied when: all mandatory OK **and** at least one alternative OK
- Leaf nodes: satisfied when directly checked

## File Structure

```
index.html                 Single-file app
sw.js                      Service Worker
manifest.json              PWA manifest
test.html                  Test runner (browser)
scripts/
  app_helpers.js           State management helpers
  tests.js                 50-test suite
  build_tree.py            Pipeline steps 1-6
  apply_phase1.py
  apply_phase2.py
  apply_phase3.py
  populate_code_names.py
  validate_schema.py
  test_navigation.py       Python navigation tests
data/
  keys_optimized.json      Generated data
assets/
  *.json                   USDA source files
docs/
  ARCHITECTURE.md          This file
  DATA_FORMAT.md           JSON schema reference
  FUNCTION_REFERENCE.md    Function API docs
  MAINTENANCE.md           Data refresh & troubleshooting
  NAVIGATION_LOGIC.md      Algorithm specification
  PUBLICATION_GUIDE.md     Release workflow
```
